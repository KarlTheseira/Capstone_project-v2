{% extends "base.html" %}
{% block title %}{{ product.title }} Â· Flash Studio{% endblock %}

{% block content %}
<div class="video-player-wrapper">
    <div class="video-container">
        {% if product.video_key %}
            <!-- Option 1: YouTube Embed (if youtube_id is set) -->
            {% if product.youtube_id %}
            <div class="embed-responsive embed-responsive-16by9">
                <iframe 
                    class="embed-responsive-item" 
                    src="https://www.youtube.com/embed/{{ product.youtube_id }}?rel=0&modestbranding=1&showinfo=0"
                    title="{{ product.title }}"
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
            
            <!-- Option 2: Vimeo Embed (if vimeo_id is set) -->
            {% elif product.vimeo_id %}
            <div class="embed-responsive embed-responsive-16by9">
                <iframe 
                    src="https://player.vimeo.com/video/{{ product.vimeo_id }}?badge=0&autopause=0&player_id=0&app_id=58479"
                    title="{{ product.title }}"
                    frameborder="0" 
                    allow="autoplay; fullscreen; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
            
            <!-- Option 3: Direct MP4 with multiple fallbacks -->
            {% else %}
            <div class="video-loading">Loading...</div>
            
            <!-- Primary: HTML5 Video with multiple sources -->
            <video 
                class="video-player" 
                id="videoPlayer" 
                controls 
                preload="metadata" 
                playsinline
                poster="{{ url_for('static', filename='uploads/' ~ product.video_thumbnail) if product.video_thumbnail else url_for('static', filename='images/placeholder.jpg') }}"
            >
                <!-- Multiple format support -->
                <source src="{{ url_for('video.play', video_id=product.id) }}" type="video/mp4">
                <source src="{{ url_for('static', filename='uploads/' ~ product.video_key) }}" type="video/mp4">
                
                <!-- Fallback: Direct download link -->
                <div class="video-fallback">
                    <p>Your browser doesn't support video playback.</p>
                    <a href="{{ url_for('video.play', video_id=product.id) }}" class="btn btn-primary" download>
                        <i class="bi bi-download"></i> Download Video
                    </a>
                </div>
            </video>
            
            <!-- Alternative: Image with play button that opens video in new tab -->
            <div class="video-thumbnail-fallback" style="display: none;">
                <img 
                    src="{{ url_for('static', filename='uploads/' ~ product.video_thumbnail) if product.video_thumbnail else url_for('static', filename='images/placeholder.jpg') }}" 
                    alt="{{ product.title }}"
                    class="img-fluid"
                >
                <div class="play-overlay">
                    <a href="{{ url_for('video.play', video_id=product.id) }}" target="_blank" class="btn btn-primary btn-lg">
                        <i class="bi bi-play-fill"></i> Play Video
                    </a>
                </div>
            </div>
            {% endif %}
        {% endif %}
    </div>
    
    <div class="video-info-panel">
        <h1 class="h3 mb-4">{{ product.title }}</h1>
        
        <div class="video-metadata">
            <div class="video-metadata-item">
                <h3>Duration</h3>
                <p>{{ product.duration_display }}</p>
            </div>
            {% if product.project_date %}
            <div class="video-metadata-item">
                <h3>Release Date</h3>
                <p>{{ product.project_date.strftime('%B %d, %Y') }}</p>
            </div>
            {% endif %}
            {% if product.client_name %}
            <div class="video-metadata-item">
                <h3>Client</h3>
                <p>{{ product.client_name }}</p>
            </div>
            {% endif %}
        </div>
        
        <div class="description">
            <h2 class="h5 mb-3">About this Project</h2>
            <p class="text-muted">{{ product.description }}</p>
        </div>
        
        {% if product.client_testimonial %}
        <div class="testimonial mt-4">
            <blockquote class="blockquote">
                <p class="mb-0">{{ product.client_testimonial }}</p>
                <footer class="blockquote-footer mt-2">{{ product.client_name }}</footer>
            </blockquote>
        </div>
        {% endif %}
        
        <!-- Video Options Panel -->
        <div class="video-options mt-4">
            <h3 class="h6">Having trouble playing the video?</h3>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="tryDirectLink()">
                    <i class="bi bi-link-45deg"></i> Direct Link
                </button>
                <a href="{{ url_for('video.play', video_id=product.id) }}" class="btn btn-outline-secondary" download>
                    <i class="bi bi-download"></i> Download
                </a>
                <button type="button" class="btn btn-outline-secondary" onclick="showThumbnailFallback()">
                    <i class="bi bi-image"></i> Show Thumbnail
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/video.css') }}">
<style>
/* Embed responsive styles */
.embed-responsive {
    position: relative;
    display: block;
    width: 100%;
    padding: 0;
    overflow: hidden;
}

.embed-responsive-16by9 {
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
}

.embed-responsive-item {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
}

/* Video fallback styles */
.video-fallback {
    padding: 2rem;
    text-align: center;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
}

.video-thumbnail-fallback {
    position: relative;
    cursor: pointer;
}

.play-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.video-options {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('videoPlayer');
    if (video) {
        // Fallback to thumbnail view if video fails to load
        video.addEventListener('error', function() {
            console.error('Video failed to load');
            showThumbnailFallback();
        });
        
        // Timeout fallback
        setTimeout(() => {
            if (video.readyState === 0) {
                console.log('Video loading timeout');
                showThumbnailFallback();
            }
        }, 15000);
    }
});

function tryDirectLink() {
    const videoUrl = "{{ url_for('video.play', video_id=product.id) }}";
    window.open(videoUrl, '_blank');
}

function showThumbnailFallback() {
    const video = document.querySelector('.video-player');
    const fallback = document.querySelector('.video-thumbnail-fallback');
    
    if (video) video.style.display = 'none';
    if (fallback) fallback.style.display = 'block';
}
</script>
{% endblock %}